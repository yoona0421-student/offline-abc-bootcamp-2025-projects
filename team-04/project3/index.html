<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI ì—¬í–‰ ì¼ì • ì¶”ì²œê¸°</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f5f7fa; padding: 2rem; max-width: 900px; margin: auto; }
    h1 { text-align: center; color: #2c3e50; }
    .input-group { margin-bottom: 1rem; }
    label { font-weight: bold; display: block; margin-bottom: 0.4rem; }
    input, select, button { padding: 0.6rem; font-size: 1rem; width: 100%; box-sizing: border-box; }
    button { background-color: #2c3e50; color: white; border: none; cursor: pointer; }
    #result, #budgetSection { background-color: #fff; padding: 1rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 1.5rem; }
    #tableWrapper { background: #fff; padding: 1rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    th { background-color: #eee; }
  </style>
</head>
<body>
  <h1>ğŸŒ AI ì—¬í–‰ ì¼ì • ì¶”ì²œê¸°</h1>

  <div class="input-group">
    <label for="budget">ì˜ˆì‚° (KRW):</label>
    <input type="number" id="budget" placeholder="ì˜ˆ: 2000000" />
  </div>

  <div class="input-group">
    <label for="people">ì¸ì› ìˆ˜:</label>
    <input type="number" id="people" placeholder="ì˜ˆ: 2ëª…" min="1" />
  </div>

  <div class="input-group">
    <label for="days">ì—¬í–‰ ê¸°ê°„ (ì¼):</label>
    <input type="number" id="days" placeholder="ì˜ˆ: 3ì¼" min="1" />
  </div>

  <div class="input-group">
    <label for="themeEmotion">í…Œë§ˆ ê°ì •:</label>
    <input type="text" id="themeEmotion" placeholder="ì˜ˆ: ì„¤ë ˜, íë§, ëª¨í—˜" />
  </div>

  <div class="input-group">
    <label for="departure">ì¶œë°œì§€:</label>
    <input type="text" id="departure" placeholder="ì˜ˆ: ì„œìš¸, ëŒ€ì „" />
  </div>

  <div class="input-group">
    <label for="theme">ì—¬í–‰ í…Œë§ˆ:</label>
    <select id="theme">
      <option value="íë§">íë§</option>
      <option value="ì•¡í‹°ë¹„í‹°">ì•¡í‹°ë¹„í‹°</option>
      <option value="ë¯¸ì‹">ë¯¸ì‹</option>
      <option value="ìì—°">ìì—°</option>
    </select>
  </div>

  <div class="input-group">
    <label for="region">ì—¬í–‰ì§€ ì¶”ì²œ ë°©ì‹:</label>
    <select id="region">
      <option value="ëœë¤">ëœë¤ ì¶”ì²œ</option>
      <option value="ì¡°ê±´">AI ì¡°ê±´ ê¸°ë°˜</option>
    </select>
  </div>

  <div class="input-group">
    <label for="travelType">ì—¬í–‰ íƒ€ì…:</label>
    <select id="travelType">
      <option value="êµ­ë‚´">êµ­ë‚´</option>
      <option value="í•´ì™¸">í•´ì™¸</option>
    </select>
  </div>

  <button onclick="getItinerary()">ì—¬í–‰ ì¼ì • ìƒì„±í•˜ê¸°</button>

  <div id="result">ì¼ì • ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
  <div id="tableWrapper"></div>
  <div id="budgetSection">
    <canvas id="budgetChart" width="400" height="400"></canvas>
  </div>

  <script>
    let budgetChartInstance = null;

    async function getItinerary() {
      const budget = parseInt(document.getElementById('budget').value);
      const people = parseInt(document.getElementById('people').value);
      const days = parseInt(document.getElementById('days').value);
      const themeEmotion = document.getElementById('themeEmotion').value.trim();
      const departure = document.getElementById('departure').value.trim();
      const theme = document.getElementById('theme').value;
      const regionPref = document.getElementById('region').value;
      const travelType = document.getElementById('travelType').value;
      const resultDiv = document.getElementById('result');
      const tableWrapper = document.getElementById('tableWrapper');
      const ctx = document.getElementById('budgetChart').getContext('2d');

      // ì…ë ¥ ê²€ì¦
      if (!budget || budget <= 0 || !people || people <= 0 || !days || days <= 0 || !departure) {
        alert('ì˜ˆì‚°, ì¸ì› ìˆ˜, ì—¬í–‰ ê¸°ê°„, ì¶œë°œì§€ë¥¼ ëª¨ë‘ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // UI ì´ˆê¸°í™”
      resultDiv.innerHTML = 'ë¡œë”© ì¤‘...';
      tableWrapper.innerHTML = '';
      if (budgetChartInstance) {
        budgetChartInstance.destroy();
        budgetChartInstance = null;
      }

      // í”„ë¡¬í”„íŠ¸ êµ¬ì„±
      const isOverseas = travelType === 'í•´ì™¸';
      let prompt = `ë„ˆëŠ” ${isOverseas ? 'í•´ì™¸' : 'êµ­ë‚´'} ì—¬í–‰ ì¼ì •ì„ í˜„ì‹¤ì ìœ¼ë¡œ ì§œì£¼ëŠ” AIì•¼. ì‚¬ìš©ì ì…ë ¥ ì •ë³´ëŠ” ë‹¤ìŒê³¼ ê°™ì•„:\n` +
                   `- ì˜ˆì‚°: ${budget}ì›\n` +
                   `- ì¸ì› ìˆ˜: ${people}ëª…\n` +
                   `- ì—¬í–‰ ê¸°ê°„: ${days}ì¼\n` +
                   `- í…Œë§ˆ ê°ì •: ${themeEmotion}\n` +
                   `- ì¶œë°œì§€: ${departure}\n` +
                   `- ì—¬í–‰ í…Œë§ˆ: ${theme}\n` +
                   `- ì—¬í–‰ì§€ ì¶”ì²œ ë°©ì‹: ${regionPref === 'ëœë¤' ? 'ë¬´ì‘ìœ„ ì¶”ì²œ' : 'AI ì¡°ê±´ ê¸°ë°˜'}\n`;
      if (isOverseas) {
        prompt += `
í•´ì™¸ì—¬í–‰ì´ë¯€ë¡œ í•­ê³µê¶Œ ì •ë³´(ì¶œë°œ/ë„ì°© ì‹œê°„, ì˜ˆìƒ ìš”ê¸ˆ)ì„ í¬í•¨í•´ ìì„¸íˆ ì•Œë ¤ì¤˜. ì‹œì°¨ë¥¼ ê³ ë ¤í•´ ì¼ì •ì„ ì¡°ì •í•˜ê³ , ì—¬í–‰ì§€ ì„¤ëª…ë„ í’ë¶€í•˜ê²Œ ì‘ì„±í•´ì¤˜. ì¸ì› ìˆ˜, í…Œë§ˆ ê°ì •, ì—¬í–‰ ê¸°ê°„ì„ ë°˜ì˜í•´ í™œë™ì„ ì¶”ì²œí•´ì¤˜.\n`;
      } else {
        prompt += `
êµ­ë‚´ì—¬í–‰ì´ë¯€ë¡œ êµí†µìˆ˜ë‹¨ê³¼ ì†Œìš” ì‹œê°„ì„ í¬í•¨í•´ ì¼ì •í‘œë¥¼ ì§œì¤˜. ì¸ì› ìˆ˜, í…Œë§ˆ ê°ì •, ì—¬í–‰ ê¸°ê°„ì„ ë°˜ì˜í•´ ì¼ì •ê³¼ ìˆ™ì†Œ ì¶”ì²œì„ ìµœì í™”í•´ì¤˜.\n`;
      }
      prompt += `
ì‘ë‹µì€ ì•„ë˜ í˜•ì‹ìœ¼ë¡œ ì œê³µí•´ì¤˜:\n` +
                `1. ì¶”ì²œ ì—¬í–‰ì§€ ì •ë³´(ë„ì‹œ ì´ë¦„ + ìƒì„¸ ì„¤ëª…)\n` +
                `2. ê° ë‚ ì§œë³„ ìƒì„¸ ì¼ì •(ì‹œê°„ | í™œë™)ì„ HTML í‘œ(table) í˜•ì‹ìœ¼ë¡œ ì œê³µ, â€œğŸ—“ï¸ Day 1â€ ë“± ë‚ ì§œ ì œëª© í¬í•¨ (ì´ ${days}ì¼ ì¼ì •)\n` +
                `3. ë§ˆì§€ë§‰ì— ì˜ˆì‚° ë¶„ë°°ë¥¼ JSON í˜•íƒœë¡œ ì œê³µí•˜ë˜, ì‚¬ìš©ìì—ê²ŒëŠ” ë³´ì´ì§€ ì•Šê²Œ ìˆ¨ê²¨ì„œ ì œê³µí•´ì¤˜:\n` +
                `<!--BUDGET_JSON_START-->\n` +
                `{\n` +
                `  "í•­ê³µ": ìˆ«ì,\n` +
                `  "ìˆ™ë°•": ìˆ«ì,\n` +
                `  "ì‹ì‚¬": ìˆ«ì,\n` +
                `  "í™œë™": ìˆ«ì,\n` +
                `  "ê¸°íƒ€": ìˆ«ì\n` +
                `}\n` +
                `<!--BUDGET_JSON_END-->`;

      // ìŠ¤íŠ¸ë¦¬ë° ìš”ì²­
      const response = await fetch('http://localhost:5000/generate/stream', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages: [
          { role: 'system', content: 'ë„ˆëŠ” í˜„ì‹¤ì ì¸ ì—¬í–‰ ì¼ì •ì„ ê³„íší•´ì£¼ëŠ” ì „ë¬¸ê°€ì•¼.' },
          { role: 'user', content: prompt }
        ] })
      });

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let fullText = '';
      resultDiv.innerHTML = '';

      // ìŠ¤íŠ¸ë¦¼ ë Œë”ë§
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        fullText += decoder.decode(value);
        const displayText = fullText.replace(/<!--BUDGET_JSON_START-->[\s\S]*?<!--BUDGET_JSON_END-->/, '');
        resultDiv.innerHTML = displayText;
      }

      // ìˆ¨ê²¨ì§„ JSON ì¶”ì¶œ
      const jsonMatch = fullText.match(/<!--BUDGET_JSON_START-->[\s\S]*?<!--BUDGET_JSON_END-->/);
      let budgetObj = null;
      if (jsonMatch) {
        try { budgetObj = JSON.parse(jsonMatch[1]); } catch (e) { console.error('ì˜ˆì‚° JSON íŒŒì‹± ì˜¤ë¥˜', e); }
      }

      // ì¼ì •í‘œ ë¶„ë¦¬
      const container = document.createElement('div');
      container.innerHTML = resultDiv.innerHTML;
      const table = container.querySelector('table');
      if (table) {
        tableWrapper.innerHTML = table.outerHTML;
        table.remove();
      }
      resultDiv.innerHTML = container.innerHTML.trim() || 'ì¼ì • ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.';

      // ì°¨íŠ¸ ë Œë”ë§
      if (budgetObj) {
        budgetChartInstance = new Chart(ctx, {
          type: 'pie', data: { labels: Object.keys(budgetObj), datasets: [{ data: Object.values(budgetObj) }] },
          options: { responsive: true, plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'ì˜ˆì‚° ë¶„ë°°' } } }
        });
      }
    }
  </script>
</body>
</html>
