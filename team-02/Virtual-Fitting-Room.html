<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ìƒ í”¼íŒ…ë£¸</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f7f7f7;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 32px;
            text-align: center;
        }
        h1 {
            font-family: Georgia, 'Times New Roman', serif;
            color: #fff;
            background: #999;
            padding: 12px 32px;
            border-radius: 10px;
            margin-bottom: 24px;
            text-align: center;
            display: inline-block;
            min-width: 0;
        }
        .upload-section {
            display: flex;
            gap: 12px;
            justify-content: center;
            align-items: center;
            margin-bottom: 24px;
        }
        .upload-box {
            flex: none;
            text-align: left;
            margin: 0 0;
        }
        .upload-box label {
            font-size: 14px;
            font-weight: normal;
            color: #333;
            background: none;
            padding: 0;
        }
        .upload-box input {
            margin-top: 6px;
        }
        #fitting-room {
            position: relative;
            width: 400px;
            height: 500px;
            margin: 0 auto;
            background: #FEF7EC;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: none;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #user-photo {
            max-height: 500px;
            width: auto;
            height: auto;
            object-fit: contain;
            position: static;
            display: block;
            margin: 0 auto;
        }
        .button-row {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 18px 0 0 0;
        }
        .button-row button {
            border: 1px solid #bbb;
            background: transparent;
            color: #333;
            font-family: inherit;
            font-size: 14px;
            padding: 8px 18px;
            border-radius: 6px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .button-row button:hover {
            border-color: #888;
        }
        .tip {
            display: none;
        }
        .clothes {
            position: absolute;
            left: 50px;
            top: 50px;
            width: 200px;
            height: auto;
            cursor: move;
            z-index: 2;
            user-select: none;
        }
        .clothes.selected {
            outline: 2px dashed #0078d7;
        }
        .resize-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #fff;
            border: 2px solid #0078d7;
            border-radius: 50%;
            right: -8px;
            bottom: -8px;
            cursor: se-resize;
            z-index: 3;
        }
        .clothes-list {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 24px;
            flex-wrap: wrap;
        }
        .clothes-thumb {
            width: 80px;
            height: 100px;
            object-fit: contain;
            background: #f0f0f0;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border 0.2s;
        }
        .clothes-thumb:hover {
            border: 2px solid #0078d7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Virtual Fitting Room</h1>
        <div class="upload-section">
            <div class="upload-box">
                <label>ì „ì‹  ì‚¬ì§„ ì—…ë¡œë“œ<br>
                    <input type="file" id="photo-upload" accept="image/*">
                </label>
            </div>
            <div class="upload-box">
                <label>ì˜· ì—…ë¡œë“œ<br>
                    <input type="file" id="clothes-json-upload" accept="application/json,image/png">
                </label>
            </div>
        </div>
        <div id="fitting-room">
            <img id="user-photo" src="" alt="ì „ì‹  ì‚¬ì§„" style="display:none;">
            <!-- ì˜· ì´ë¯¸ì§€ê°€ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
        </div>
        <div class="button-row">
            <button id="save-lookbook">ë£©ë¶ ì €ì¥</button>
            <button id="show-lookbooks">ì €ì¥ëœ ëª©ë¡</button>
            <button id="clear-lookbook">í”¼íŒ…ë£¸ ì´ˆê¸°í™”</button>
        </div>
        <div style="margin-top: 16px; padding: 12px; background: #f8f9fa; border-radius: 6px; font-size: 13px; color: #666; text-align: left;">
            <strong>ğŸ’¡ ì‚¬ìš©ë²•:</strong><br>
            â€¢ ì˜· ì´ë¯¸ì§€ ë“œë˜ê·¸: ìœ„ì¹˜ ì´ë™<br>
            â€¢ Shift + ë“œë˜ê·¸: í¬ê¸° ì¡°ì ˆ<br>
            â€¢ ë§ˆìš°ìŠ¤ íœ : í¬ê¸° ì¡°ì ˆ<br>
            â€¢ ìš°í•˜ë‹¨ í•¸ë“¤: í¬ê¸° ì¡°ì ˆ<br>
            â€¢ ğŸ—‘ï¸ ë²„íŠ¼: ì‚­ì œ
        </div>
        <div id="lookbook-modal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:99999; align-items:center; justify-content:center;">
            <div style="background:#fff; border-radius:12px; padding:32px; min-width:320px; max-width:90vw; max-height:80vh; overflow:auto; box-shadow:0 4px 24px rgba(0,0,0,0.15);">
                <h2 style="margin-top:0;">ì €ì¥ëœ ë£©ë¶ ëª©ë¡</h2>
                <div id="lookbook-list"></div>
                <button id="close-lookbook-modal" style="margin-top:24px;">ë‹«ê¸°</button>
            </div>
        </div>
        <div class="clothes-list" id="clothes-list">
            <!-- ì˜· ì¸ë„¤ì¼ì´ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
        </div>
    </div>
    <script>
    // ì „ì‹  ì‚¬ì§„ ì—…ë¡œë“œ
    const photoUpload = document.getElementById('photo-upload');
    const userPhoto = document.getElementById('user-photo');
    photoUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(ev) {
                userPhoto.src = ev.target.result;
                userPhoto.style.display = 'block';
                // ì „ì‹ ì‚¬ì§„ì„ localStorageì—ë„ ì €ì¥ (ë£©ë¶ ë¯¸ë¦¬ë³´ê¸°ìš©)
                localStorage.setItem('user-photo', ev.target.result);
            };
            reader.readAsDataURL(file);
        }
    });

    // ì˜· JSON/PNG ì—…ë¡œë“œ ë° ì¸ë„¤ì¼ í‘œì‹œ
    const clothesJsonUpload = document.getElementById('clothes-json-upload');
    const clothesList = document.getElementById('clothes-list');
    let clothesData = [];

    clothesJsonUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        if (file.type === 'application/json') {
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    clothesData = JSON.parse(ev.target.result);
                    renderClothesList();
                } catch (err) {
                    alert('ì˜· JSON íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            };
            reader.readAsText(file);
        } else if (file.type === 'image/png') {
            const reader = new FileReader();
            reader.onload = function(ev) {
                // PNG íŒŒì¼ì„ ë°”ë¡œ ì˜· ì•„ì´í…œìœ¼ë¡œ ì¶”ê°€
                const name = prompt('ì˜· ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', 'ìƒˆ ì˜·');
                const desc = prompt('ì˜· ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', 'ì„¤ëª…');
                if (name) {
                    const item = { name, desc, image: ev.target.result };
                    clothesData.push(item);
                    renderClothesList();
                }
            };
            reader.readAsDataURL(file);
        } else {
            alert('JSON ë˜ëŠ” PNG íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        }
    });

    function renderClothesList() {
        clothesList.innerHTML = '';
        clothesData.forEach((item, idx) => {
            const div = document.createElement('div');
            div.style.display = 'inline-block';
            div.style.textAlign = 'center';
            div.style.margin = '8px';
            // ì¸ë„¤ì¼
            const img = document.createElement('img');
            img.src = item.image;
            img.className = 'clothes-thumb';
            img.title = item.name;
            img.onclick = function() {
                addClothesToFittingRoom(item);
            };
            // ì´ë¦„/ì„¤ëª…
            const name = document.createElement('div');
            name.textContent = item.name;
            name.style.fontWeight = 'bold';
            name.style.fontSize = '13px';
            const desc = document.createElement('div');
            desc.textContent = item.desc;
            desc.style.fontSize = '12px';
            desc.style.color = '#888';
            div.appendChild(img);
            div.appendChild(name);
            div.appendChild(desc);
            clothesList.appendChild(div);
        });
    }

    // ì˜· ì´ë¯¸ì§€ë¥¼ í”¼íŒ…ë£¸ì— ì¶”ê°€
    function addClothesToFittingRoom(item, state) {
        const fittingRoom = document.getElementById('fitting-room');
        const clothes = document.createElement('img');
        clothes.src = item.image;
        clothes.className = 'clothes';
        clothes.style.left = state?.left || '100px';
        clothes.style.top = state?.top || '100px';
        clothes.style.width = state?.width || '200px';
        clothes.draggable = false;
        clothes.setAttribute('data-name', item.name);
        clothes.setAttribute('data-desc', item.desc);
        // íˆ´íŒ
        clothes.addEventListener('mouseenter', function(e) {
            showTooltip(clothes, item.name, item.desc);
        });
        clothes.addEventListener('mouseleave', function(e) {
            hideTooltip();
        });
        // ì‚­ì œ ë²„íŠ¼
        const delBtn = document.createElement('div');
        delBtn.innerHTML = 'ğŸ—‘ï¸';
        delBtn.style.position = 'absolute';
        delBtn.style.right = '-18px';
        delBtn.style.top = '-18px';
        delBtn.style.background = '#fff';
        delBtn.style.border = '1px solid #ccc';
        delBtn.style.borderRadius = '50%';
        delBtn.style.width = '24px';
        delBtn.style.height = '24px';
        delBtn.style.display = 'flex';
        delBtn.style.alignItems = 'center';
        delBtn.style.justifyContent = 'center';
        delBtn.style.cursor = 'pointer';
        delBtn.style.zIndex = '10';
        delBtn.title = 'ì‚­ì œ';
        delBtn.onclick = function(e) {
            e.stopPropagation();
            fittingRoom.removeChild(clothes);
            hideTooltip();
        };
        clothes.appendChild(delBtn);
        fittingRoom.appendChild(clothes);
        addDragAndResize(clothes);
    }

    // íˆ´íŒ í‘œì‹œ
    let tooltipDiv = null;
    function showTooltip(target, name, desc) {
        hideTooltip();
        tooltipDiv = document.createElement('div');
        tooltipDiv.style.position = 'fixed';
        tooltipDiv.style.background = '#222';
        tooltipDiv.style.color = '#fff';
        tooltipDiv.style.padding = '8px 14px';
        tooltipDiv.style.borderRadius = '8px';
        tooltipDiv.style.fontSize = '13px';
        tooltipDiv.style.zIndex = '9999';
        tooltipDiv.innerHTML = `<b>${name}</b><br>${desc}`;
        document.body.appendChild(tooltipDiv);
        document.addEventListener('mousemove', moveTooltip);
    }
    function moveTooltip(e) {
        if (tooltipDiv) {
            tooltipDiv.style.left = (e.clientX + 12) + 'px';
            tooltipDiv.style.top = (e.clientY + 12) + 'px';
        }
    }
    function hideTooltip() {
        if (tooltipDiv) {
            document.body.removeChild(tooltipDiv);
            tooltipDiv = null;
            document.removeEventListener('mousemove', moveTooltip);
        }
    }

    // ë“œë˜ê·¸ & í¬ê¸° ì¡°ì ˆ ê¸°ëŠ¥ (íœ /í•¸ë“¤/í´ë¦­ë“œë˜ê·¸)
    function addDragAndResize(clothes) {
        let isDragging = false, isResizing = false, isDirectResize = false;
        let startX, startY, startLeft, startTop, startWidth;

        // í¬ê¸° ì¡°ì ˆ í•¸ë“¤ ì¶”ê°€
        const handle = document.createElement('div');
        handle.className = 'resize-handle';
        clothes.appendChild(handle);

        clothes.addEventListener('mousedown', function(e) {
            if (e.target === handle) return;
            
            // Shift í‚¤ë¥¼ ëˆ„ë¥´ê³  ìˆìœ¼ë©´ í¬ê¸° ì¡°ì ˆ ëª¨ë“œ
            if (e.shiftKey) {
                isDirectResize = true;
                clothes.classList.add('selected');
                startX = e.clientX;
                startY = e.clientY;
                startWidth = clothes.offsetWidth;
                document.body.style.cursor = 'se-resize';
                return;
            }
            
            isDragging = true;
            clothes.classList.add('selected');
            startX = e.clientX;
            startY = e.clientY;
            startLeft = parseInt(clothes.style.left);
            startTop = parseInt(clothes.style.top);
            document.body.style.cursor = 'move';
        });

        document.addEventListener('mousemove', function(e) {
            if (isDragging) {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                clothes.style.left = (startLeft + dx) + 'px';
                clothes.style.top = (startTop + dy) + 'px';
            }
            if (isResizing) {
                const dx = e.clientX - startX;
                let newWidth = Math.max(40, startWidth + dx);
                clothes.style.width = newWidth + 'px';
            }
            if (isDirectResize) {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                // ëŒ€ê°ì„  ê±°ë¦¬ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í¬ê¸° ì¡°ì ˆ
                const distance = Math.sqrt(dx * dx + dy * dy);
                const direction = dx + dy > 0 ? 1 : -1;
                let newWidth = Math.max(40, startWidth + (distance * direction * 0.5));
                clothes.style.width = newWidth + 'px';
            }
        });

        document.addEventListener('mouseup', function(e) {
            if (isDragging || isResizing || isDirectResize) {
                isDragging = false;
                isResizing = false;
                isDirectResize = false;
                clothes.classList.remove('selected');
                document.body.style.cursor = '';
            }
        });

        handle.addEventListener('mousedown', function(e) {
            e.stopPropagation();
            isResizing = true;
            clothes.classList.add('selected');
            startX = e.clientX;
            startWidth = clothes.offsetWidth;
            document.body.style.cursor = 'se-resize';
        });

        // ë§ˆìš°ìŠ¤ íœ ë¡œ í¬ê¸° ì¡°ì ˆ
        clothes.addEventListener('wheel', function(e) {
            e.preventDefault();
            let w = clothes.offsetWidth;
            let delta = e.deltaY < 0 ? 20 : -20;
            w = Math.max(40, w + delta);
            clothes.style.width = w + 'px';
        });
    }

    // ë£©ë¶ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°/ì´ˆê¸°í™”
    // ì—¬ëŸ¬ ë£©ë¶ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°/ì‚­ì œ/ëª©ë¡
    function getLookbooks() {
        return JSON.parse(localStorage.getItem('lookbooks') || '[]');
    }
    function setLookbooks(arr) {
        localStorage.setItem('lookbooks', JSON.stringify(arr));
    }

    document.getElementById('save-lookbook').onclick = function() {
        const fittingRoom = document.getElementById('fitting-room');
        const clothesEls = fittingRoom.querySelectorAll('.clothes');
        let lookbook = [];
        clothesEls.forEach(el => {
            lookbook.push({
                name: el.getAttribute('data-name'),
                desc: el.getAttribute('data-desc'),
                image: el.src,
                left: el.style.left,
                top: el.style.top,
                width: el.style.width
            });
        });
        let name = prompt('ë£©ë¶ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', 'ë‚˜ì˜ ë£©ë¶');
        if (!name) return;
        let lookbooks = getLookbooks();
        lookbooks.push({ name, items: lookbook, date: new Date().toLocaleString() });
        setLookbooks(lookbooks);
        alert('ë£©ë¶ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    };

    document.getElementById('show-lookbooks').onclick = function() {
        const modal = document.getElementById('lookbook-modal');
        const listDiv = document.getElementById('lookbook-list');
        listDiv.innerHTML = '';
        let lookbooks = getLookbooks();
        if (lookbooks.length === 0) {
            listDiv.innerHTML = '<p style="color:#888;">ì €ì¥ëœ ë£©ë¶ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
            // ì„¸ë¡œë¡œ ë‚˜ì—´
            listDiv.style.display = 'flex';
            listDiv.style.flexDirection = 'column';
            listDiv.style.alignItems = 'center';
            lookbooks.forEach((lb, idx) => {
                // ë¯¸ë¦¬ë³´ê¸° ë°•ìŠ¤ ìƒì„± (ì´ë¯¸ì§€ë§Œ)
                const previewBox = document.createElement('div');
                previewBox.style.border = '1px solid #eee';
                previewBox.style.borderRadius = '8px';
                previewBox.style.padding = '8px';
                previewBox.style.marginBottom = '18px';
                previewBox.style.background = '#fafafa';
                previewBox.style.display = 'block';
                // ì„¸ë¡œí˜• ìº”ë²„ìŠ¤ ìƒì„±
                const canvas = document.createElement('canvas');
                canvas.width = 120;
                canvas.height = 180;
                canvas.style.borderRadius = '6px';
                canvas.style.background = '#e9ecef';
                canvas.style.boxShadow = '0 2px 8px rgba(0,0,0,0.07)';
                canvas.style.objectFit = 'contain';
                canvas.style.display = 'block';
                // ìº”ë²„ìŠ¤ì— ì´ë¯¸ì§€ ë Œë”ë§
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#e9ecef';
                ctx.fillRect(0,0,canvas.width,canvas.height);
                // ì „ì‹ ì‚¬ì§„ ë Œë”ë§ (ë¹„ìœ¨ ìœ ì§€, ì¤‘ì•™)
                let photo = localStorage.getItem('user-photo');
                let photoPromise = Promise.resolve();
                if (photo) {
                    photoPromise = new Promise(resolve => {
                        const img = new window.Image();
                        img.onload = function() {
                            ctx.globalAlpha = 1.0;
                            let pw = img.naturalWidth;
                            let ph = img.naturalHeight;
                            let cw = canvas.width;
                            let ch = canvas.height;
                            let scale = Math.min(cw/pw, ch/ph);
                            let dw = pw * scale;
                            let dh = ph * scale;
                            let dx = (cw - dw) / 2;
                            let dy = (ch - dh) / 2;
                            ctx.drawImage(img, dx, dy, dw, dh);
                            resolve();
                        };
                        img.src = photo;
                    });
                }
                // ì˜·ë“¤ ë Œë”ë§
                let promises = [photoPromise];
                lb.items.forEach(item => {
                    promises.push(new Promise(resolve => {
                        const img = new window.Image();
                        img.onload = function() {
                            let left = parseInt(item.left||'100')/400*canvas.width;
                            let top = parseInt(item.top||'100')/600*canvas.height;
                            let width = parseInt(item.width||'200')/400*canvas.width;
                            let height = img.naturalHeight/img.naturalWidth * width;
                            ctx.drawImage(img, left, top, width, height);
                            resolve();
                        };
                        img.src = item.image;
                    }));
                });
                Promise.all(promises).then(()=>{
                    // nothing needed
                });
                previewBox.appendChild(canvas);
                // ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ ì¶”ê°€
                const loadBtn = document.createElement('button');
                loadBtn.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸°';
                loadBtn.style.marginTop = '10px';
                loadBtn.style.display = 'block';
                loadBtn.style.width = '100%';
                loadBtn.style.background = 'transparent';
                loadBtn.style.border = '1px solid #bbb';
                loadBtn.style.color = '#333';
                loadBtn.style.fontFamily = 'inherit';
                loadBtn.style.fontSize = '14px';
                loadBtn.style.padding = '6px 0';
                loadBtn.style.borderRadius = '6px';
                loadBtn.style.cursor = 'pointer';
                loadBtn.onmouseover = function() { loadBtn.style.borderColor = '#0078d7'; };
                loadBtn.onmouseout = function() { loadBtn.style.borderColor = '#bbb'; };
                loadBtn.onclick = function() {
                    loadLookbook(idx);
                    modal.style.display = 'none';
                };
                previewBox.appendChild(loadBtn);
                // ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'ì‚­ì œ';
                deleteBtn.style.marginTop = '8px';
                deleteBtn.style.display = 'block';
                deleteBtn.style.width = '100%';
                deleteBtn.style.background = 'transparent';
                deleteBtn.style.border = '1px solid #f55';
                deleteBtn.style.color = '#f55';
                deleteBtn.style.fontFamily = 'inherit';
                deleteBtn.style.fontSize = '14px';
                deleteBtn.style.padding = '6px 0';
                deleteBtn.style.borderRadius = '6px';
                deleteBtn.style.cursor = 'pointer';
                deleteBtn.onmouseover = function() { deleteBtn.style.borderColor = '#d00'; deleteBtn.style.color = '#d00'; };
                deleteBtn.onmouseout = function() { deleteBtn.style.borderColor = '#f55'; deleteBtn.style.color = '#f55'; };
                deleteBtn.onclick = function() {
                    if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        let lookbooks = getLookbooks();
                        lookbooks.splice(idx, 1);
                        setLookbooks(lookbooks);
                        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        document.getElementById('show-lookbooks').click();
                    }
                };
                previewBox.appendChild(deleteBtn);
                listDiv.appendChild(previewBox);
            });
        }
        modal.style.display = 'flex';
        // ì´ë²¤íŠ¸ ìœ„ì„ ì œê±° (í…ìŠ¤íŠ¸/ë²„íŠ¼ ì—†ìŒ)
        listDiv.onclick = null;
    };

    document.getElementById('close-lookbook-modal').onclick = function() {
        document.getElementById('lookbook-modal').style.display = 'none';
    };

    function loadLookbook(idx) {
        const fittingRoom = document.getElementById('fitting-room');
        fittingRoom.querySelectorAll('.clothes').forEach(el => {
            el.dispatchEvent(new Event('remove'));
            el.remove();
        });
        let lookbooks = getLookbooks();
        if (lookbooks[idx]) {
            lookbooks[idx].items.forEach(item => {
                addClothesToFittingRoom(item, item);
            });
        }
    }

    document.getElementById('clear-lookbook').onclick = function() {
        const fittingRoom = document.getElementById('fitting-room');
        fittingRoom.querySelectorAll('.clothes').forEach(el => {
            // ì»¤ìŠ¤í…€ remove ì´ë²¤íŠ¸ë¡œ í…Œë‘ë¦¬ë„ ì‚­ì œ
            el.dispatchEvent(new Event('remove'));
            el.remove();
        });
        hideTooltip();
    };
    </script>
</body>
</html>
